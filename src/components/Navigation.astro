---
import Icons from './Icons.astro';
import { getLangFromUrl, useTranslations } from '../i18n';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const currentPath = Astro.url.pathname;
---

<nav class="fixed top-0 left-0 right-0 z-50 bg-black/80 backdrop-blur-md border-b border-gray-800">
  <div class="max-w-6xl mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <a href={`/${lang}`} class="text-xl font-bold bg-gradient-to-r from-purple-400 to-green-400 bg-clip-text text-transparent">
        Diego Ramirez
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-8">
        <a href={`/${lang}#home`} class="nav-link">
          {t('nav.home')}
        </a>
        <a href={`/${lang}#about`} class="nav-link">
          {t('nav.about')}
        </a>
        <a href={`/${lang}#experience`} class="nav-link">
          {t('nav.experience')}
        </a>
        <a href={`/${lang}#projects`} class="nav-link">
          {t('nav.projects')}
        </a>
        <a href={`/${lang}#contact`} class="nav-link">
          {t('nav.contact')}
        </a>
      </div>

      <!-- Controls -->
      <div class="flex items-center space-x-4">
        <!-- Language Selector -->
        <div class="relative">
          <button id="language-btn" class="control-btn cursor-pointer" aria-label="Select Language">
            <Icons icon="globe" size={18} />
          </button>
          <div id="language-menu" class="absolute right-0 mt-2 w-32 bg-gray-800 border border-gray-700 rounded-md shadow-lg opacity-0 invisible transition-all duration-200">
            <a href="/en" class="block px-4 py-2 text-sm hover:bg-gray-700 rounded-md text-gray-300">English</a>
            <a href="/es" class="block px-4 py-2 text-sm hover:bg-gray-700 rounded-md text-gray-300">Espa√±ol</a>
          </div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button id="mobile-menu-toggle" class="control-btn md:hidden" aria-label="Toggle Mobile Menu">
          <div id="menu-icon" class="block">
            <Icons icon="menu" size={18}/>
          </div>
          <div id="close-icon" class="hidden">
            <Icons icon="x" size={18} />
          </div>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="md:hidden border-t border-gray-800 overflow-hidden transition-all duration-300 max-h-0">
      <div class="py-4 space-y-2">
        <a href={`/${lang}#home`} class="block px-4 py-2 nav-link">
          {t('nav.home')}
        </a>
        <a href={`/${lang}#about`} class="block px-4 py-2 nav-link">
          {t('nav.about')}
        </a>
        <a href={`/${lang}#experience`} class="block px-4 py-2 nav-link">
          {t('nav.experience')}
        </a>
        <a href={`/${lang}#projects`} class="block px-4 py-2 nav-link">
          {t('nav.projects')}
        </a>
        <a href={`/${lang}#contact`} class="block px-4 py-2 nav-link">
          {t('nav.contact')}
        </a>
      </div>
    </div>
  </div>
</nav>

<script>
  // Language menu toggle
  const languageBtn = document.getElementById('language-btn');
  const languageMenu = document.getElementById('language-menu');
  
  languageBtn?.addEventListener('click', () => {
    const isVisible = languageMenu?.classList.contains('opacity-100');
    languageMenu?.classList.toggle('opacity-0', isVisible);
    languageMenu?.classList.toggle('opacity-100', !isVisible);
    languageMenu?.classList.toggle('invisible', isVisible);
    languageMenu?.classList.toggle('visible', !isVisible);
  });

  // Close language menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!languageBtn?.contains(e.target as Node) && !languageMenu?.contains(e.target as Node)) {
      languageMenu?.classList.add('opacity-0', 'invisible');
      languageMenu?.classList.remove('opacity-100', 'visible');
    }
  });

  // Section tracking for active navigation
  function updateActiveNavLink() {
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.nav-link');
    
    let currentSection = 'home';
    
    sections.forEach((section) => {
      const rect = section.getBoundingClientRect();
      if (rect.top <= 200 && rect.bottom >= 200) {
        currentSection = section.id;
      }
    });
    
    // Remove active class from all links
    navLinks.forEach(link => {
      link.classList.remove('active');
    });
    
    // Add active class to current section link
    const activeLink = document.querySelector(`a[href$="#${currentSection}"]`);
    if (activeLink) {
      activeLink.classList.add('active');
    }
  }

  // Smooth scroll for navigation links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = link.getAttribute('href');
      if (href && href.includes('#')) {
        const targetId = href.split('#')[1];
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.scrollIntoView({ behavior: 'smooth' });
        }
      }
    });
  });

  // Listen for scroll events
  let scrollTimeout: NodeJS.Timeout;
  window.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      requestAnimationFrame(updateActiveNavLink);
    }, 10);
  });

  // Initial check
  document.addEventListener('DOMContentLoaded', updateActiveNavLink);

  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');
  
  mobileMenuToggle?.addEventListener('click', () => {
    const isOpen = mobileMenu?.style.maxHeight !== '0px' && mobileMenu?.style.maxHeight !== '';
    
    if (isOpen) {
      mobileMenu!.style.maxHeight = '0px';
      menuIcon?.classList.remove('hidden');
      menuIcon?.classList.add('block');
      closeIcon?.classList.remove('block');
      closeIcon?.classList.add('hidden');
    } else {
      mobileMenu!.style.maxHeight = mobileMenu!.scrollHeight + 'px';
      menuIcon?.classList.remove('block');
      menuIcon?.classList.add('hidden');
      closeIcon?.classList.remove('hidden');
      closeIcon?.classList.add('block');
    }
  });
</script>

<style>
  .nav-link {
    color: rgb(156 163 175);
    transition: color 0.2s ease-in-out;
    position: relative;
    text-decoration: none;
  }
  
  .nav-link:hover {
    color: white;
  }
  
  .nav-link::after {
    content: '';
    position: absolute;
    width: 100%;
    transform: scaleX(0);
    height: 2px;
    bottom: 0;
    left: 0;
    background: linear-gradient(to right, rgb(168 85 247), rgb(34 197 94));
    transform-origin: bottom right;
    transition: transform 0.25s ease-out;
  }
  
  .nav-link:hover::after {
    transform: scaleX(1);
    transform-origin: bottom left;
  }
  
  .nav-link.active {
    color: white;
    font-weight: 500;
  }
  
  .nav-link.active::after {
    transform: scaleX(1);
    transform-origin: bottom left;
    transition: transform 0.5s ease-in-out;
  }
  
  .control-btn {
    padding: 8px;
    border-radius: 6px;
    background-color: rgb(31 41 55);
    border: 1px solid rgb(55 65 81);
    color: rgb(209 213 219);
    transition: all 0.2s ease-in-out;
  }
  
  .control-btn:hover {
    background-color: rgb(55 65 81);
  }
</style>
